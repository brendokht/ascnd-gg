model Event {
  id             String      @id @default(uuid(7))
  hubId          String      @map("hub_id")
  hub            Hub         @relation(fields: [hubId], references: [id], onDelete: Cascade)
  name           String      @unique
  displayName    String      @map("display_name")
  description    String?
  logo           String?
  banner         String?
  titleId        String      @map("title_id")
  title          Title       @relation(fields: [titleId], references: [id], onDelete: Cascade)
  status         EventStatus
  startDate    DateTime    @map("start_date")
  endDate DateTime    @map("end_date")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @default(now()) @updatedAt @map("updated_at")

  stages Stage[]

  @@map("event")
}

model Stage {
  id             String      @id @default(uuid(7))
  eventId        String      @map("event_id")
  event          Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name           String
  displayName    String      @map("display_name")
  description    String?
  stageTypeId    String      @map("stage_type_id")
  stageType      StageType   @relation(fields: [stageTypeId], references: [id], onDelete: Cascade)
  status         StageStatus
  startDate    DateTime    @map("start_date")
  endDate DateTime    @map("end_date")
  registrationStartDate  DateTime             @map("registration_start_date")
  registrationEndDate    DateTime             @map("registration_end_date")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @default(now()) @updatedAt @map("updated_at")

  invitations StageInvite[]
  settings    StageSetting[]
  phases      Phase[]
  stageTeams  StageTeam[]

  @@map("stage")
}

model StageType {
  id          String   @id @default(uuid(7))
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  stages Stage[]

  @@map("stage_type")
}
model StageSetting {
  stageId                String                @id @map("stage_id")
  stage                  Stage                 @relation(fields: [stageId], references: [id], onDelete: Cascade)
  minTeams               Int                   @default(2) @map("min_teams")
  maxTeams               Int                   @default(128) @map("max_teams")
  teamSize               Int                   @map("team_size")
  numberOfSubstitutes    Int                   @default(1) @map("number_of_substitutes")
  numberOfCoaches        Int                   @default(1) @map("number_of_coaches")
  allowDraws             Boolean               @default(false) @map("allow_draws")
  // TODO: Add check constraint to ensure if allowDraws is true, this must be set
  drawPolicy             DrawResolutionPolicy?  @map("draw_policy")
  // TODO: Make sure word gameMode (or gamemode) is consistent (pick one)
  gameModePoolIds        String[]              @map("game_mode_pool_ids")
  perGameGamemodeVeto    Boolean               @map("per_game_gamemode_veto")
  perMatchGamemodeVeto   Boolean               @map("per_match_gamemode_veto")
  mapPoolIds             String[]              @map("map_pool_ids")
  perGameMapVeto         Boolean               @map("per_game_map_veto")
  perMatchMapVeto        Boolean               @map("per_match_map_veto")
  characterPoolIds       String[]              @map("character_pool_ids")
  perGameCharacterVeto   Boolean               @map("per_game_character_veto")
  perMatchCharacterVeto  Boolean               @map("per_match_character_veto")
  itemPoolIds            String[]              @map("item_pool_ids")
  perGameItemVeto        Boolean               @map("per_game_item_veto")
  perMatchItemVeto       Boolean               @map("per_match_item_veto")
  perGameSideVeto        Boolean               @map("per_game_side_veto")
  perMatchSideVeto       Boolean               @map("per_match_side_veto")
  titleSettings          Json?                 @map("title_settings") @db.JsonB
  seedingType            StageSeedingType      @map("seeding_type")
  joinType               StageJoinType         @map("join_type")
  isLocked               Boolean               @map("is_locked")
  stageSettingTemplateId String?               @map("stage_setting_template_id")
  stageSettingTemplate   StageSettingTemplate? @relation(fields: [stageSettingTemplateId], references: [id], onDelete: Cascade)
  createdAt              DateTime              @default(now()) @map("created_at")
  updatedAt              DateTime              @default(now()) @updatedAt @map("updated_at")

  @@map("stage_setting")
}

model StageSettingTemplate {
  id            String   @id @default(uuid(7))
  name          String
  displayName   String   @map("display_name")
  titleId       String   @map("title_id")
  title         Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)
  settings      Json     @db.JsonB
  custom        Boolean  @default(false)
  createdBy     String?  @map("created_by")
  createdByUser User?    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  version       Int      @default(1)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  stageSettings StageSetting[]

  @@unique([titleId, name, version])
  @@map("stage_setting_template")
}

model Phase {
  id                 String      @id @default(uuid(7))
  stageId            String      @map("stage_id")
  stage              Stage       @relation(fields: [stageId], references: [id], onDelete: Cascade)
  matchFormatId      String      @map("match_format_id")
  matchFormat        MatchFormat @relation(fields: [matchFormatId], references: [id], onDelete: Cascade)
  matchIndexStart    Int?        @map("match_index_start")
  matchIndexEnd      Int?        @map("match_index_end")
  mapVetoOrder       Json?       @map("map_veto_order")
  characterVetoOrder Json?       @map("character_veto_order")
  itemVetoOrder      Json?       @map("item_veto_order")
  sideVetoOrder      Json?       @map("side_veto_order")
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @default(now()) @updatedAt @map("updated_at")

  matches Match[]

  @@map("phase")
}

enum StageSeedingType {
  RANDOM
  MANUAL

  @@map("stage_seeding_type")
}

enum StageJoinType {
  OPEN
  REQUEST
  INVITE

  @@map("stage_join_type")
}

enum StageStatus {
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  PENDING
  ONGOING
  CANCELLED
  FINISHED

  @@map("stage_status")
}

enum EventStatus {
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  PENDING
  ONGOING
  CANCELLED
  FINISHED

  @@map("event_status")
}
