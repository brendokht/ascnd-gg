/* TODO: Support Game Prerequisites
 * Need to support per Game Prerequisites
 * for potential games like League of Legends
 */

 /* TODO: Decide how to ensure safety and dynamic rendering
  * If a game decides to change the prerequisite process,
  * I need a way to ensure the proper data is shown,
  * and has a Zod schema.
  */

model Match {
  id          String   @id @default(uuid(7))
  eventId String
  team1Id String
  team1 Team @relation(name: "Team1Matches", fields: [team1Id], references: [id], onDelete: Cascade)
  team2Id String?
  team2 Team? @relation(name: "Team2Matches", fields: [team2Id], references: [id], onDelete: Cascade)
  matchPrerequisiteResult Json? @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  matchGames MatchGames[]
  eventMatches EventMatches[]

  @@map("match")
}

model MatchFormat {
  id          String   @id @default(uuid(7))
  name String @unique
  displayName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  prerequisites MatchPrerequisite[]
  events Event[]

  @@map("match_format")
}

model MatchPrerequisite {
  id          String   @id @default(uuid(7))
  name String 
  displayName String
  titleId String
  title Title @relation(fields: [titleId], references: [id], onDelete: Cascade)
  formatId String
  format MatchFormat @relation(fields: [formatId], references: [id], onDelete: Cascade)
  prerequisite Json @db.JsonB
  custom Boolean @default(false)
  createdBy String?
  createdByUser User? @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  version Int @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  events Event[]

  // TODO: Check constraint for protected words? ("offcial", etc.)

  @@unique([name, version, formatId, titleId])
  @@map("match_prerequisite")
}

model Game {
  id          String   @id @default(uuid(7))
  team1Score Int @default(0)
  team2Score Int @default(0)
  playerStatistics Json @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  matchGames MatchGames[]

  @@map("game")
}

model MatchGames {
  matchId String
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  gameId String
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@id([matchId, gameId])
  @@map("match_game")
}

model EventMatches {
  matchId String
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  eventId String
  event Event@relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@id([matchId, eventId])
  @@map("event_match")
}