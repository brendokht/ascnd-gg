model Match {
  id                         String                @id @default(uuid(7))
  phaseId                    String                @map("phase_id")
  phase                      Phase                 @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  matchIndex                 Int                   @map("match_index")
  team1Id                    String                @map("team_1_id")
  team1                      Team                  @relation(name: "Team1Matches", fields: [team1Id], references: [id], onDelete: Cascade)
  team2Id                    String?               @map("team_2_id")
  team2                      Team?                 @relation(name: "Team2Matches", fields: [team2Id], references: [id], onDelete: Cascade)
  team1Score                 Int                   @map("team_1_score")
  team2Score                 Int                   @map("team_2_score")
  gameWinsNeeded             Int                   @map("game_wins_needed")
  result                     Result                @default(SCHEDULED)
  scheduledAt                DateTime?             @map("scheduled_at")
  playerStatistics           Json?                 @map("player_statistics") @db.JsonB
  drawPolicyUsed             DrawResolutionPolicy? @map("draw_policy_used")
  matchSettingTemplateId     String?               @map("match_setting_template_id")
  matchSettingTemplate       MatchSettingTemplate? @relation(fields: [matchSettingTemplateId], references: [id], onDelete: Cascade)
  matchSettingTemplateResult Json?                 @map("match_setting_template_result") @db.JsonB
  createdAt                  DateTime              @default(now()) @map("created_at")
  updatedAt                  DateTime              @default(now()) @updatedAt @map("updated_at")

  games Game[]

  @@unique([phaseId, matchIndex])
  @@map("match")
}

model MatchFormat {
  id                          String   @id @default(uuid(7))
  name                        String   @unique
  displayName                 String   @map("display_name")
  shortName                   String   @map("short_name")
  targetScore                 Int      @map("target_score")
  gamesPerMatch               Int?     @map("games_per_match")
  gameSettingTemplateRequired Boolean? @default(false) @map("game_setting_template_required")
  metadata                    Json?    @db.JsonB
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @default(now()) @updatedAt @map("updated_at")

  prerequisites MatchSettingTemplate[]
  phases        Phase[]

  @@map("match_format")
}

model MatchSettingTemplate {
  id            String      @id @default(uuid(7))
  name          String
  displayName   String      @map("display_name")
  titleId       String      @map("title_id")
  title         Title       @relation(fields: [titleId], references: [id], onDelete: Cascade)
  formatId      String      @map("format_id")
  format        MatchFormat @relation(fields: [formatId], references: [id], onDelete: Cascade)
  settings      Json        @db.JsonB
  custom        Boolean     @default(false)
  createdBy     String?     @map("created_by")
  createdByUser User?       @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  version       Int         @default(1)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @default(now()) @updatedAt @map("updated_at")

  StageSetting StageSetting[]
  matches      Match[]

  @@unique([titleId, formatId, version])
  @@unique([titleId, formatId, name])
  @@map("match_setting_template")
}

model Game {
  id                        String               @id @default(uuid(7))
  matchId                   String               @map("match_id")
  match                     Match                @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team1Score                Int                  @default(0) @map("team_1_score")
  team2Score                Int                  @default(0) @map("team_2_score")
  result                    Result               @default(SCHEDULED)
  gameSettingTemplateId     String?              @map("game_setting_template_id")
  gameSettingTemplate       GameSettingTemplate? @relation(fields: [gameSettingTemplateId], references: [id], onDelete: Cascade)
  gameSettingTemplateResult Json?                @map("game_setting_template_result") @db.JsonB
  playerStatistics          Json?                @map("player_statistics") @db.JsonB
  createdAt                 DateTime             @default(now()) @map("created_at")
  updatedAt                 DateTime             @default(now()) @updatedAt @map("updated_at")

  @@map("game")
}

model GameSettingTemplate {
  id            String   @id @default(uuid(7))
  name          String
  displayName   String   @map("display_name")
  titleId       String   @map("title_id")
  title         Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)
  settings      Json     @db.JsonB
  custom        Boolean  @default(false)
  createdBy     String?  @map("created_by")
  createdByUser User?    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  version       Int      @default(1)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  games        Game[]
  StageSetting StageSetting[]

  @@unique([titleId, version, name])
  @@map("game_setting_template")
}

enum Result {
  SCHEDULED
  PREREQUISITE
  ONGOING
  CANCELLED
  ABORTED
  DISPUTED
  TEAM_1_WIN
  TEAM_2_WIN
  DRAW

  @@map("result")
}
